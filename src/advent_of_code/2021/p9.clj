(ns advent-of-code.2021.p9
  (:require [clojure.string :as str]))

(def example "2199943210\n3987894921\n9856789892\n8767896789\n9899965678")
(def input "9987675345698765453987654321234589999899878923493212345678999998656782467898999899878301234578998787\n9876543234789765322398743210123567898789767899986101239899789876543101567897898798763212355989987656\n3987784014897654310987654331235679965697644998765232345997654989765212799956999679854343466799976545\n2199875323998765421298776542346789434595433498754345456789543499876353489549876542975858977899876439\n1012965439899896432359987667457896546789322349987656987898932445987454578932987621986767898943989598\n2125976598798989943467898876589999858899910959898767898976101234598966689431298320987898999432399987\n3234987987656579894578989987679998769999899898769879999965422345679298995420139434598999896543459875\n4346799876545456789679877898789769878989798799656989899876563496799109989591298548999689789656598764\n5956998765434345698989765679895456989678679678943496789988689989898997979989987657987565698787989543\n6899898764321234567999876989954345696534598789432134679999799976987656765778998769766464989999865432\n7987679653210155789999997899875456789323999899521012345899899765698943254667999898954353578999654321\n9696598654323234589788998998986567898919894958933423456789999753459892123458998987893212467898765432\n8543498765434545679567899987987679987898743147894934567898989432398789334767987876789101298989876543\n7656789878545656789338989876598789986797654235679895678997878941987678975879896545698914345678987654\n9868998989656877892129678965439899975498754346998796789986867932954569986798765434567895458989998765\n8979987798787898921012567894321999874329985459876589899985457899873458987987654323469986567899869876\n7899876549898959999923456789432398765909876567987678999875322987654567898998773212378997698998754987\n6534997831999943987894567897543999899899987878998789789964201298765678919679654323456789799987632399\n5424598942689899876789678987659899988788999989019895699865362349986989103498795434567899899996549989\n4212349653498789765699989798798789877697898999999924789976457899798993212379986747698946999897998878\n5334569878989678934998995679987678954545987899789935689987567987649898763467897858789235798789887867\n6446878989876569976897893459876567893239876797689898789397679893234789654598998979999546999698785458\n7557989199987457898956789998984348994124965323486789895498798789123569875989109989898969898598654345\n8998994398796346899545699876543236789549876412345678979569987679023456989878992398767898767469643234\n9999689987654235695434689987652125678956987954456789768979876568994568999867989987659999955398759345\n7887578976543123489545679698983234789768998765677993457899765456789878997654878998767899843229898956\n6543469998768245678956789529865445899879999896798912349998987347899989989653467899879998732019987897\n7672398999875456989767895439876556789989989999899102356987798456789899878932356789989987643498976789\n8954987899986567899878976546989667993498979978976212469996549567895798969991245699899998754987685698\n9769876989987898901989997656898789101997768769895433498765439878934987656789346789788999869876564567\n9898765778998979312397899767999893249876753656789656569976524989423976546789498997697986998765473456\n3987654569789765434456976978999974756965432345678987678987734694319887635689989998456894219874321567\n2198733477678978645797895989989865669876543766799998789599848789998765212678979999367975323985432378\n3989821234568999756898934599878976798998754567898999897679959899899874323599867895459876434596543458\n9876432347679549887969423498969987897989865698997899979898767998798765435679756899567987546987654567\n9876543489789832998953210987658998996579878789876588965939989987659987546789645688979987657898785678\n3987654579898721239998723976547899987467989999995477894321098765545698687895436577898998898999896789\n2398766789989654359899644597656999876345697679654356965434197543434989798954323456987899939998987893\n1239887894678965498788987698987999765234789598765467896545976532129879899996534567896789123976798912\n0945998923567896997687898999298987653123696439876588987679876549098765945987965778945693239875459901\n9896789434678999876575999899399199762064594321987678998789989698987654326599878989238789459954345899\n6797898645789998767434598798989349872165689410198989769899898997898543212367989994345678998986254678\n5789949756894987654323497687878959989278796521239797653998767876799654302456999965456899987432123689\n4569439887893998799934598576967898995478897432345698992989545665698775212567899876697899876543234567\n5678921998969899987899974475459997898567998945456789989878932124569854323498976989989965987654345678\n6799990199656789876798863212349976987678999896897899879767893234698765434578965699878974598785458789\n9899989989543298765987652101267895999799998789998998968456789345999879545679854598767943459987569893\n3998979678932129894598543323458934889934987698999987654345895469876997656789765987659894567998678942\n1987667569892099989679656445667895679899876597896596543256896567989998789899876798547689978999789531\n9876553456789989878998767986898996798788995456789987752125789678998999897999987899534567899989898940\n8765432345679878967999899597959789987576789347899876543234589789987899975689999987656789929876967891\n8764321234698766556899995329345678987455678956789989684348678999876798764567898998769893212975456932\n9863210123459654345688989910258789876323589969894398765457789998765679923459987869878999109864349894\n9854525234598743234567979891345897995474567898989239878767899997654567895678996555989998919753239789\n9765434545987655455679865789457896986567678967878946989878959876543456789789789434599987898954398679\n9896565656898766767999954567978965497678989656567898998989245988652346799894698765679876767895976532\n9987879768999879879878323489989654398789893432349899987690159899721278967923989876798965456987987699\n8998989879988989998965412397898765219899762101234789996521998798754367899999878987987654347898998987\n7659395989876897987654323456789898323998753242345678989439887699865456899989769999876543236789019986\n8543214598765456798987654589896987536789894355456989879598754589876967999877658999997655345678998965\n7654323679876578969999865678945698545678976566567898769987653479989898998766546898998786457799987654\n8795498793997989657899976789234987657799987677678965657898794567998789987653234567899898568899998723\n9989989932398996546789989890123498968989998788789654346789887679899678996442123458901987678999899812\n9878879993989875237899999989254989979878999899898766869895998997676567894321015667892398789999798923\n7767767989878943123978999878969978998967899922939878998953219876565456976534124578943469999988697654\n6553459876767894234568986767898767987656789210125989987994101985432389997645234567894590129876598785\n5432345985458995679799875456989659876545456991234899876789919996676569987656545678965989239988439986\n4321359894346789789987654345678943965434345789546799765679898987787878998787656989879879998895321298\n5430198765497899894298763234567899876521234899987987654598787999898989109898767899998967897654210129\n6541679876989945999987654345678989987752345678999999766987656579999793212999878999987656789775323234\n6432589989877899998998765476989978998843459789998939878996545468989654329989999998798787894989876545\n7543458998965778987679976687898767898754678999987923989876432345678976498978989987659898943497987676\n8654567987854567896563987798998656899865789019876894599987321238789098987967878998743989932346798888\n9766779876543488997432398899987745679877892198765789998765450139989129876754568999974567895459999999\n9877898765632356789543459921096434567988943989654567899986521234678998765323467899865679976598897912\n9988987654521237989699567899987558978999659876543457899987634656899986544212456789877889987987656893\n9999996543210357678987998998998667989431968997652346998998785667901997432101348995998994398996545789\n8932987987631234589476789987689978999599878994321345997899996778929899546712467894239987469997434679\n7891098876546349679345678965578899998989989989935459876979897889298778994324578943190296599989323567\n6989129989865478993234567893456799987878998776896567965468789990199656989435678954989987989978934569\n5678949999976569310123689932345689876569899565789778984345688999987645678945789769979999878767897698\n4567898999987679453294594321017992985498765434698999993234567898765434899656899998768999765457898987\n7698987898799789564989695532399891996309899323456789832125678919876325999797999887657987654346789876\n8999876789654998679879989649989799876212987437899898761012348901985476789898998765431298743235689985\n9899965689543249998765679998767678965429876556945987652125667899876787899979459963210139852123798954\n8788754799932129879654587789656567896578987987899876543234799998989898998764349854321298764234567893\n7656543458794298965443445678932456789789598998901997654345678997693939789943298765432359879876899952\n6543252345679987654352237899751577899895459789212398897656889986542124599892109887545456989987896541\n8432101489989999875210128932967698998901345699924569998767994987431023999789213998676569995699965430\n7654312678999998996321239999878789767892396989895678989879993976545129897678954598789678934567976521\n8976433589998767987542356789999891557789989978789789467998989897685398789569899989899789325679897432\n9987544567899655698653468999987910345679878765678992345987878799896987667348798976949895434599789545\n9999655778999543219766567899876621234598765454567891249876567689929876543237667895435976565987679656\n8798789989988959309877678999765432545699654323479910134995456578912997632123456789523498878996598977\n6549891299876898912988989789876547686987543212567891239984323469329876321014567898654569989985456799\n1234932997764667893499995678987658798998654403459932398765012478998765432125678979866789699876345678\n0356799876543456994567894567898967899019873212378993987654139989219876843336789565977896579843234589\n1235789987532345789978943456899878978929764323456789398543248892101998765459895434598965498765445678\n2356897698421234567899432346789989767899875435668891239654356789432789887567976323699654329876786789\n3567896543210246788987541457892499848921986546879910129767568996545699998678988434789543210989897899")

(defn parse [input]
  (->> (str/split-lines input)
       (map seq)
       (mapv (partial mapv #(Character/digit ^char % 10)))))

(defn adjacent-locations [input i j]
  [(get (get input i) (inc j) 9)
   (get (get input i) (dec j) 9)
   (get (get input (inc i)) j 9)
   (get (get input (dec i)) j 9)])

(defn low-point? [input point]
  (< (get-in input point)
     (reduce min (apply adjacent-locations input point))))

(defn part-1 [input]
  (->> (for [i (range (count input))
             j (range (count (first input)))]
         [i j])
       (filter (partial low-point? input))
       (map (partial get-in input))
       (map inc)
       (reduce + 0)))

(defn adjacent-points [input i j]
  (cond-> []
    (not= 0 i) (conj [(dec i) j])
    (not= 0 j) (conj [i (dec j)])
    (not= (dec (count input)) i) (conj [(inc i) j])
    (not= (dec (count (first input))) j) (conj [i (inc j)])))

(defn basin-points [input point]
  (loop [border [point]
         points #{}]
    (if (empty? border)
      points
      (let [next-border (->> border
                             (mapcat #(apply adjacent-points input %))
                             (remove points)
                             (remove #(= 9 (get-in input %))))]
        (recur next-border (into points next-border))))))

(defn part-2 [input]
  (->> (for [i (range (count input))
             j (range (count (first input)))]
         [i j])
       (filter (partial low-point? input))
       (map (partial basin-points input))
       (map count)
       (sort-by identity >)
       (take 3)
       (reduce * 1)))

(comment
  (-> example parse part-1)
  (-> input parse part-1)
  (-> example parse part-2)
  (-> input parse part-2))
